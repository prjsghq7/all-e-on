<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>ë³µì§€ ì„œë¹„ìŠ¤</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; margin: 0; padding: 1rem; }
        .toolbar { display: flex; gap: 8px; margin: 12px 0; align-items: center; }
        .item { padding: 12px; border-bottom: 1px solid #ddd; }
        .name { font-weight: bold; }
        .muted { color: #666; font-size: 0.9rem; }

        /* âœ… ê¸°ë³¸ì€ ìˆ¨ê¹€ */
        .modal {
            position: fixed; inset: 0;
            background-color: rgba(0,0,0,0.6);
            display: none;
            align-items: center; justify-content: center;
            z-index: 9999;
        }
        /* âœ… ë³´ì—¬ì¤„ ë•Œë§Œ flex */
        .modal.visible { display: flex; }

        .modal-content {
            background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 400px;
            text-align: center;
        }
        .modal-content button { margin-top: 1rem; }
    </style>
</head>
<body>

<!-- âœ… ê¸°ë³¸ì€ ìˆ¨ê¹€ ìƒíƒœ, JSê°€ í•„ìš” ì‹œì—ë§Œ .visible ì¶”ê°€ -->
<div class="modal" id="introModal" aria-hidden="true">
    <div class="modal-content">
        <p>ì´ í˜ì´ì§€ëŠ” ì‹œê°ì¥ì• ì¸ê³¼ ë…¸ì¸ë¶„ë“¤ì„ ìœ„í•´ ìŒì„± ì¸ì‹ì„ ì§€ì›í•©ë‹ˆë‹¤.<br>ìŒì„±ìœ¼ë¡œ ì´ìš©í•˜ì‹œë ¤ë©´ ìŒì„±ìœ¼ë¡œ ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜, ì—”í„° í‚¤ë¥¼ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</p>
        <button onclick="closeModal()">í™•ì¸</button>
    </div>
</div>

<h1>ë³µì§€ ì„œë¹„ìŠ¤</h1>

<div class="toolbar">
    <button id="voice">ğŸ¤ ìŒì„±ìœ¼ë¡œ ê²€ìƒ‰</button>
    <button id="toggle-stt">ğŸ”ˆ ìŒì„±ì¸ì‹ ë„ê¸°</button>
    <button id="read" th:if="${summary != null}">ìš”ì•½ ì½ì–´ì£¼ê¸°</button>
</div>

<div th:if="${#strings.isEmpty(kw)}" class="muted">ê²€ìƒ‰ì–´ë¥¼ ë§ì”€í•´ ì£¼ì„¸ìš”. ì˜ˆ: â€œë…¸ì¸ ë³µì§€ ì•Œë ¤ì¤˜â€</div>

<div id="list">
    <div class="item" th:each="it, iStat : ${items}">
        <div class="name" th:text="${iStat.index + 1} + '. ' + ${it['servNm']}">1. ì„œë¹„ìŠ¤ëª…</div>
        <div class="muted" th:text="${it['jurMnofNm']}">ì†Œê´€ë¶€ì²˜</div>
        <div th:text="${it['servDgst']}">ìš”ì•½</div>
        <div class="muted" th:text="'ì˜¨ë¼ì¸ì‹ ì²­: ' + ${it['onapPsbltYn']} + ' | ì œê³µìœ í˜•: ' + ${it['srvPvsnNm']}">ë¶€ê°€ì •ë³´</div>
        <a th:href="${it['servDtlLink']}" target="_blank" rel="noopener">ìƒì„¸ ë°”ë¡œê°€ê¸°</a>
    </div>
    <div th:if="${#lists.isEmpty(items) and not #strings.isEmpty(kw)}">ì¡°ê±´ì— ë§ëŠ” ë³µì§€ ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
</div>

<script th:inline="javascript">
    let recognition;
    let isListening = true;

    const summary = /*[[${summary}]]*/ '[[${summary}]]';

    // ===== TTS =====
    function speak(txt) {
        if (!txt) return;
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = 'ko-KR';
        speechSynthesis.speak(u);
    }
    function stopSpeak(){ speechSynthesis.cancel(); }

    // ===== STT =====
    function initSTT() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) { alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }

        recognition = new SR();
        recognition.lang = 'ko-KR';
        recognition.interimResults = false;
        recognition.continuous = false;

        recognition.onresult = async (e) => {
            const transcript = e.results[0][0].transcript;
            try {
                const res = await fetch("/test/welfare/voice", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ transcript })
                });
                const data = await res.json();
                if (data.redirectTo) location.href = data.redirectTo;
            } catch (err) {
                alert("ìŒì„± ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
            } finally {
                if (isListening) {
                    try { recognition.start(); } catch(e) {}
                }
            }
        };
        recognition.onerror = () => {
            if (isListening) {
                try { recognition.start(); } catch(e) {}
            }
        };
    }
    function startSTT(){ if (!recognition) initSTT(); if (!isListening) return; try{ recognition.start(); }catch(e){} }
    function stopSTT(){ if (recognition) recognition.abort(); }
    function toggleSTT(){
        isListening = !isListening;
        const btn = document.getElementById('toggle-stt');
        if (isListening) { startSTT(); btn.innerText = 'ğŸ”ˆ ìŒì„±ì¸ì‹ ë„ê¸°'; }
        else { stopSTT(); btn.innerText = 'ğŸ”‡ ìŒì„±ì¸ì‹ ì¼œê¸°'; }
    }

    // ===== ëª¨ë‹¬ ì œì–´ =====
    function showIntroModalIfNeeded() {
        const seen = localStorage.getItem('hasSeenModal') === 'true';  // âœ… ëª…ì‹œ ë¹„êµ
        // âœ… "ê²€ìƒ‰ ì „(ìš”ì•½ ì—†ìŒ)"ì¼ ë•Œë§Œ ëª¨ë‹¬ ê³ ë ¤
        if (!seen) {
            const modal = document.getElementById('introModal');
            modal.classList.add('visible');
            modal.setAttribute('aria-hidden', 'false');
            setTimeout(() => {
                speak('ì´ í˜ì´ì§€ëŠ” ì‹œê°ì¥ì• ì¸ê³¼ ë…¸ì¸ë¶„ë“¤ì„ ìœ„í•´ ìŒì„± ì¸ì‹ì„ ì§€ì›í•©ë‹ˆë‹¤. ìŒì„±ìœ¼ë¡œ ì´ìš©í•˜ì‹œë ¤ë©´ í™”ë©´ì„ í„°ì¹˜í•˜ì‹œê±°ë‚˜ ì—”í„° í‚¤ë¥¼ ëˆŒëŸ¬ ì£¼ì„¸ìš”.');
            }, 300);
        } else {
            startSTT();  // ì´ë¯¸ ë³¸ ì  ìˆìœ¼ë©´ ë°”ë¡œ STT
        }
    }

    function closeModal() {
        const modal = document.getElementById('introModal');
        modal.classList.remove('visible');          // âœ… ìˆ¨ê¹€
        modal.setAttribute('aria-hidden', 'true');
        localStorage.setItem('hasSeenModal', 'true');  // âœ… 1íšŒ í‘œì‹œ
        speak('ìŒì„± ì¸ì‹ì´ ì‹œì‘ë©ë‹ˆë‹¤. ê²€ìƒ‰ì–´ë¥¼ ë§ì”€í•´ ì£¼ì„¸ìš”.');
        startSTT();
    }

    // ===== ì´ˆê¸°í™” =====
    document.addEventListener('DOMContentLoaded', () => {
        initSTT();

        if (!summary || summary.trim() === '') {
            showIntroModalIfNeeded();    // ê²€ìƒ‰ ì „: ëª¨ë‹¬ ê³ ë ¤
        } else {
            startSTT();                  // ê²€ìƒ‰ ê²°ê³¼ í˜ì´ì§€: STT ë°”ë¡œ ON
            stopSpeak();
            setTimeout(() => speak(summary), 800);
        }

        // ë²„íŠ¼ë“¤
        document.getElementById('voice').addEventListener('click', startSTT);
        document.getElementById('toggle-stt').addEventListener('click', toggleSTT);

        const readBtn = document.getElementById('read');
        if (readBtn && summary) {
            readBtn.addEventListener('click', () => { stopSpeak(); speak(summary); });
        }

        window.addEventListener('keydown', (e) => { if (e.key === 'Enter') startSTT(); });
    });
</script>

</body>
</html>
