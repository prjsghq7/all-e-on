<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë³µì§€ ì„œë¹„ìŠ¤</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; margin: 0; padding: 1rem; }
        .toolbar { display: flex; gap: 8px; margin: 12px 0; align-items: center; }
        .item { padding: 12px; border-bottom: 1px solid #ddd; }
        .name { font-weight: bold; }
        .muted { color: #666; font-size: 0.9rem; }
        .modal {
            position: fixed; inset: 0;
            background-color: rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 400px;
            text-align: center;
        }
        .modal-content button {
            margin-top: 1rem;
        }
    </style>
</head>
<body>

<div class="modal" id="introModal" th:if="${#strings.isEmpty(kw)}">
    <div class="modal-content">
        <p>ì´ í˜ì´ì§€ëŠ” ì‹œê°ì¥ì• ì¸ê³¼ ë…¸ì¸ë¶„ë“¤ì„ ìœ„í•´ ìŒì„± ì¸ì‹ì„ ì§€ì›í•©ë‹ˆë‹¤.<br>ìŒì„±ìœ¼ë¡œ ì´ìš©í•˜ì‹œë ¤ë©´ ìŒì„±ìœ¼ë¡œ ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜, ì—”í„° í‚¤ë¥¼ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</p>
        <button onclick="closeModal()">í™•ì¸</button>
    </div>
</div>

<h1>ë³µì§€ ì„œë¹„ìŠ¤</h1>

<div class="toolbar">
    <button id="voice">ğŸ¤ ìŒì„±ìœ¼ë¡œ ê²€ìƒ‰</button>
    <button id="read" th:if="${summary != null}">ìš”ì•½ ì½ì–´ì£¼ê¸°</button>
</div>

<div th:if="${#strings.isEmpty(kw)}" class="muted">ê²€ìƒ‰ì–´ë¥¼ ë§ì”€í•´ ì£¼ì„¸ìš”. ì˜ˆ: â€œë…¸ì¸ ë³µì§€ ì•Œë ¤ì¤˜â€</div>

<div id="list">
    <div class="item" th:each="it, iStat : ${items}">
        <div class="name" th:text="${iStat.index + 1} + '. ' + ${it['servNm']}">1. ì„œë¹„ìŠ¤ëª…</div>
        <div class="muted" th:text="${it['jurMnofNm']}">ì†Œê´€ë¶€ì²˜</div>
        <div th:text="${it['servDgst']}">ìš”ì•½</div>
        <div class="muted" th:text="'ì˜¨ë¼ì¸ì‹ ì²­: ' + ${it['onapPsbltYn']} + ' | ì œê³µìœ í˜•: ' + ${it['srvPvsnNm']}">ë¶€ê°€ì •ë³´</div>
        <a th:href="${it['servDtlLink']}" target="_blank" rel="noopener">ìƒì„¸ ë°”ë¡œê°€ê¸°</a>
    </div>
    <div th:if="${#lists.isEmpty(items) and not #strings.isEmpty(kw)}">ì¡°ê±´ì— ë§ëŠ” ë³µì§€ ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
</div>

<script th:inline="javascript">
    // ===== TTS =====
    function speak(txt) {
        if (!txt) return;
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = 'ko-KR';
        speechSynthesis.speak(u);
    }
    function stopSpeak() { speechSynthesis.cancel(); }

    // ===== ì•ˆë‚´ ëª¨ë‹¬ =====
    function closeModal() {
        document.getElementById('introModal').style.display = 'none';
        speak("ì´ í˜ì´ì§€ëŠ” ì‹œê°ì¥ì• ì¸ê³¼ ë…¸ì¸ë¶„ë“¤ì„ ìœ„í•´ ìŒì„± ì¸ì‹ì„ ì§€ì›í•©ë‹ˆë‹¤. ìŒì„±ìœ¼ë¡œ ì´ìš©í•˜ì‹œë ¤ë©´ ìŒì„±ìœ¼ë¡œ ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜, ì—”í„° í‚¤ë¥¼ ëˆŒëŸ¬ ì£¼ì„¸ìš”.");
    }

    // ===== summary ìë™ ì½ê¸° ì²˜ë¦¬ =====
    const summary = /*[[${summary}]]*/ '[[${summary}]]';

    document.addEventListener('DOMContentLoaded', () => {
        if (!summary || summary.trim() === '') {
            // ê²€ìƒ‰ ì „ ì•ˆë‚´ë§Œ ì½ê¸°
            setTimeout(() => {
                speak("ì´ í˜ì´ì§€ëŠ” ì‹œê°ì¥ì• ì¸ê³¼ ë…¸ì¸ë¶„ë“¤ì„ ìœ„í•´ ìŒì„± ì¸ì‹ì„ ì§€ì›í•©ë‹ˆë‹¤. ìŒì„±ìœ¼ë¡œ ì´ìš©í•˜ì‹œë ¤ë©´ ìŒì„±ìœ¼ë¡œ ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜, ì—”í„° í‚¤ë¥¼ ëˆŒëŸ¬ ì£¼ì„¸ìš”.");
            }, 3000);
        } else {
            // ê²€ìƒ‰ ê²°ê³¼ ìˆìœ¼ë©´ ìš”ì•½ ìë™ ì½ê¸°
            stopSpeak();
            setTimeout(() => {
                speak(summary);
            }, 1000); // ì•½ê°„ ë”œë ˆì´ ì¤˜ì„œ ì•ˆì •ì ìœ¼ë¡œ ì½ê²Œ í•¨
        }
    });

    // ===== ìˆ˜ë™ ì½ê¸° ë²„íŠ¼ë„ ìœ ì§€ =====
    const readBtn = document.getElementById('read');
    if (readBtn && summary) {
        readBtn.addEventListener('click', () => {
            stopSpeak();
            speak(summary);
        });
    }

    // ===== STT (ìŒì„± ì¸ì‹) =====
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    function startSTT() {
        if (!SpeechRecognition) {
            alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }
        const r = new SpeechRecognition();
        r.lang = 'ko-KR';
        r.interimResults = false;
        r.continuous = false;

        r.onresult = async (e) => {
            const transcript = e.results[0][0].transcript;
            try {
                const res = await fetch("/test/welfare/voice", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ transcript })
                });
                const data = await res.json();
                if (data.redirectTo) location.href = data.redirectTo;
            } catch (err) {
                alert("ìŒì„± ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
            }
        };
        r.onerror = () => {};
        r.start();
    }

    document.getElementById('voice').addEventListener('click', startSTT);
    window.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') startSTT();
    });
</script>

</body>
</html>
